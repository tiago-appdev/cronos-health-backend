# Cronos Health ‚Äî Backend (API REST)

Este es el backend del sistema **Cronos Health**, desarrollado con **Express.js**, que expone una API RESTful para gestionar turnos m√©dicos, usuarios, historial cl√≠nico, encuestas de satisfacci√≥n y notificaciones.

## üöÄ Configuraci√≥n R√°pida

### Opci√≥n Recomendada: Configuraci√≥n Autom√°tica (Full-Stack)

Para una configuraci√≥n completa del sistema (frontend y backend) en un solo paso, utiliza nuestro script de inicio autom√°tico:

**Windows (PowerShell):**
```powershell
# Descargar el script de inicio
Invoke-WebRequest -Uri "https://raw.githubusercontent.com/tiago-appdev/cronos-health-backend/main/start.ps1" -OutFile "start.ps1"

# Habilitar ejecuci√≥n de scripts (solo primera vez)
Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope Process -Force

# Ejecutar
.\start.ps1

```
**Linux (Bash):**
```bash
# Descargar el script de inicio
curl -o start.sh "https://raw.githubusercontent.com/tiago-appdev/cronos-health-backend/main/start.sh"

# Dar permisos de ejecuci√≥n
chmod +x start.sh

# Ejecutar
./start.sh
``` 

### Opci√≥n 2: Configuraci√≥n Manual con Docker

```bash
# Clonar el repositorio
git clone https://github.com/tiago-appdev/cronos-health-backend.git
cd cronos-health-backend

# Instalar dependencias
npm install

# Configurar variables de entorno
cp .env-template .env
# Editar .env con tus configuraciones

# Iniciar con Docker (incluye base de datos y seeding)
npm run docker:up:build
```

### Opci√≥n 3: Configuraci√≥n Manual

```bash
# Instalar dependencias
npm install

# Configurar variables de entorno
cp .env-template .env

# Iniciar solo las bases de datos con Docker
docker compose up -d postgres postgres-test

# Poblar con datos de ejemplo (opcional)
npm run seed

# Iniciar en modo desarrollo
npm run dev
```

### Cuentas de Prueba

Puedes utilizar las siguientes credenciales para acceder a la plataforma:

| Rol | Email | Contrase√±a |
|-----|-------|------------|
| **Admin** | admin@cronoshealth.com | password123 |
| **Paciente** | juan.perez@email.com | password123 |
| **Doctor** | luis.garcia@email.com | password123 |

## üì¶ Scripts Disponibles

### Desarrollo

```bash
npm run dev              # Modo desarrollo con nodemon
npm start               # Producci√≥n
npm run seed            # Poblar BD con datos de ejemplo
npm run health          # Verificar salud de la aplicaci√≥n
```

### Testing

```bash
npm test                # Ejecutar tests
npm run test:watch      # Tests en modo watch
npm run test:coverage   # Cobertura de tests
npm run test:setup      # Configurar BD de pruebas
```

### Docker

```bash
npm run docker:up              # Iniciar servicios
npm run docker:up:build        # Construir e iniciar
npm run docker:down            # Detener servicios
npm run docker:logs            # Ver logs
npm run docker:clean           # Limpiar Docker
```

## üèóÔ∏è Arquitectura y Estructura

```
cronos-health-backend/
‚îú‚îÄ‚îÄ .github/workflows/         # CI/CD workflows
‚îú‚îÄ‚îÄ db/                        # Scripts SQL de inicializaci√≥n
‚îú‚îÄ‚îÄ scripts/                   # Scripts de utilidad
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ controllers/           # Controladores de la API
‚îÇ   ‚îú‚îÄ‚îÄ middleware/            # Middleware personalizado
‚îÇ   ‚îú‚îÄ‚îÄ models/               # Modelos de datos
‚îÇ   ‚îú‚îÄ‚îÄ routes/               # Definici√≥n de rutas
‚îÇ   ‚îî‚îÄ‚îÄ tests/               # Tests unitarios y de integraci√≥n
‚îú‚îÄ‚îÄ docker-compose.yml        # Configuraci√≥n Docker desarrollo
‚îú‚îÄ‚îÄ Dockerfile               # Imagen Docker multi-stage
‚îî‚îÄ‚îÄ package.json
```

## üõ†Ô∏è Configuraci√≥n

### Variables de Entorno

Crear un archivo `.env` con las siguientes variables:

```env
PORT=4000
DATABASE_URL=postgres://cronos_user:cronos_pass@localhost:5432/cronos_db
JWT_SECRET=tu_clave_secreta_muy_segura
JWT_EXPIRATION=24h
NODE_ENV=development
```

### Base de Datos

El proyecto utiliza Docker para la gesti√≥n de PostgreSQL:

- **Base de datos principal**: `localhost:5432/cronos_db`
- **Base de datos de pruebas**: `localhost:5433/cronos_test_db`

## üì° Endpoints de la API

### Autenticaci√≥n

| M√©todo | Ruta                 | Descripci√≥n            | Auth Requerida |
| ------ | -------------------- | ---------------------- | -------------- |
| POST   | `/api/auth/register` | Registro de usuario    | No             |
| POST   | `/api/auth/login`    | Inicio de sesi√≥n       | No             |
| GET    | `/api/auth/user`     | Obtener usuario actual | S√≠             |

### Citas M√©dicas

| M√©todo | Ruta                        | Descripci√≥n                 | Auth Requerida |
| ------ | --------------------------- | --------------------------- | -------------- |
| GET    | `/api/appointments`         | Listar citas del usuario    | S√≠             |
| POST   | `/api/appointments`         | Crear nueva cita            | S√≠             |
| GET    | `/api/appointments/:id`     | Obtener cita espec√≠fica     | S√≠             |
| PUT    | `/api/appointments/:id`     | Actualizar cita             | S√≠             |
| DELETE | `/api/appointments/:id`     | Cancelar cita               | S√≠             |
| GET    | `/api/appointments/doctors` | Listar doctores disponibles | S√≠             |

### Encuestas de Satisfacci√≥n

| M√©todo | Ruta                      | Descripci√≥n                     | Auth Requerida |
| ------ | ------------------------- | ------------------------------- | -------------- |
| POST   | `/api/surveys`            | Enviar encuesta (pacientes)     | S√≠             |
| GET    | `/api/surveys/my-surveys` | Ver mis encuestas (pacientes)   | S√≠             |
| GET    | `/api/surveys`            | Ver todas las encuestas (admin) | S√≠ (Admin)     |
| GET    | `/api/surveys/stats`      | Estad√≠sticas de encuestas       | S√≠ (Admin)     |

### Anal√≠ticas (Admin)

| M√©todo | Ruta                                      | Descripci√≥n                   | Auth Requerida |
| ------ | ----------------------------------------- | ----------------------------- | -------------- |
| GET    | `/api/analytics/stats`                    | Estad√≠sticas del sistema      | S√≠ (Admin)     |
| GET    | `/api/analytics/recent-activity`          | Actividad reciente            | S√≠ (Admin)     |
| GET    | `/api/analytics/appointment-distribution` | Distribuci√≥n por especialidad | S√≠ (Admin)     |
| GET    | `/api/analytics/monthly-trends`           | Tendencias mensuales          | S√≠ (Admin)     |
| GET    | `/api/analytics/doctor-metrics`           | M√©tricas de m√©dicos           | S√≠ (Admin)     |
| GET    | `/api/analytics/patient-metrics`          | M√©tricas de pacientes         | S√≠ (Admin)     |

### Administraci√≥n

| M√©todo | Ruta                   | Descripci√≥n                | Auth Requerida |
| ------ | ---------------------- | -------------------------- | -------------- |
| POST   | `/api/admin/users`     | Crear usuario              | S√≠ (Admin)     |
| GET    | `/api/admin/users`     | Listar todos los usuarios  | S√≠ (Admin)     |
| GET    | `/api/admin/users/:id` | Obtener usuario espec√≠fico | S√≠ (Admin)     |
| PUT    | `/api/admin/users/:id` | Actualizar usuario         | S√≠ (Admin)     |
| DELETE | `/api/admin/users/:id` | Eliminar usuario           | S√≠ (Admin)     |

## üîÑ CI/CD Pipeline

### Estrategia de Ramas

- **`develop`**: Rama de desarrollo (CI solamente)
- **Feature branches**: Crear PRs hacia `develop`

### Workflow Autom√°tico

**CI en Develop**:

- Tests automatizados
- Auditor√≠a de seguridad
- Construcci√≥n de im√°genes Docker
- Verificaci√≥n de c√≥digo

## üê≥ Docker

### Desarrollo

```bash
# Iniciar entorno completo
npm run docker:up:build

# Ver logs en tiempo real
npm run docker:logs

# Detener servicios
npm run docker:down
```

## ‚úÖ Caracter√≠sticas Implementadas

- [x] Sistema de autenticaci√≥n con JWT
- [x] CRUD completo de citas m√©dicas
- [x] Gesti√≥n de doctores y pacientes
- [x] Encuestas de satisfacci√≥n de pacientes
- [x] Panel de anal√≠ticas para administradores
- [x] Sistema de gesti√≥n de usuarios (admin)
- [x] Chat en tiempo real entre doctores y pacientes
- [x] Historial m√©dico digital
- [x] Tests unitarios y de integraci√≥n completos
- [x] Dockerizaci√≥n completa
- [x] CI/CD con GitHub Actions
- [x] Datos de prueba pre-cargados
- [x] Sistema de notificaciones push

## üîú Pr√≥ximas Caracter√≠sticas

- [ ] Integraci√≥n con servicios de email
- [ ] Reportes y estad√≠sticas avanzadas
- [ ] API de webhooks
- [ ] Integraci√≥n con servicios de pago

## üõ°Ô∏è Seguridad

- Encriptaci√≥n de contrase√±as con bcrypt
- Autenticaci√≥n JWT con expiraci√≥n
- Validaci√≥n de entrada en todos los endpoints


## üîß Soluci√≥n de Problemas

### Problemas Comunes

1. **Error de conexi√≥n a BD**:

   ```bash
   npm run docker:down
   npm run docker:up:build
   ```

2. **Puerto ocupado**:
   ```bash
   # Cambiar puerto en .env
   PORT=4001
   ```

## Testing

### 1. Configurar el Entorno de Pruebas

```bash
# Instalar dependencias si a√∫n no est√°n instaladas
npm install

# Iniciar la base de datos de pruebas
docker compose up -d postgres-test

# Ejecutar todas las pruebas
npm test
```

### 2. Comandos de Prueba Disponibles

```bash
# Ejecutar todas las pruebas una vez
npm test

# Ejecutar pruebas en modo observaci√≥n (se reejecutan al cambiar archivos)
npm test:watch

# Ejecutar pruebas con informe de cobertura
npm test:coverage

# Solo configurar la base de datos de pruebas
npm run test:setup
```

## üèóÔ∏è Arquitectura de Pruebas

### Base de Datos de Pruebas Separada

- **BD de Producci√≥n/Desarrollo**: `postgres://localhost:5432/cronos_db`
- **BD de Pruebas**: `postgres://localhost:5433/cronos_test_db`

La base de datos de pruebas corre en un puerto diferente (5433) y est√° completamente aislada de los datos de desarrollo.

### Aislamiento de Pruebas

Cada prueba est√° completamente aislada:

- La base de datos se limpia antes de cada prueba
- Se crean datos frescos para cada prueba
- Ninguna prueba afecta a otra
- No se tocan datos de producci√≥n

### Utilidades de Prueba

La clase `TestUtils` proporciona m√©todos auxiliares para crear datos de prueba:

```javascript
import { TestUtils } from "./test-utils.js";

// Crear usuarios de prueba
const patient = await TestUtils.createTestPatient();
const doctor = await TestUtils.createTestDoctor();
const admin = await TestUtils.createTestAdmin();

// Generar tokens JWT
const token = TestUtils.generateTestToken(user);

// Crear datos de prueba
const appointment = await TestUtils.createTestAppointment(patientId, doctorId);
const survey = await TestUtils.createTestSurvey(patientId);
```

## üìÅ Estructura de Pruebas

```
src/tests/
‚îú‚îÄ‚îÄ setup.js              # Configuraci√≥n global de pruebas
‚îú‚îÄ‚îÄ test-utils.js         # Funciones auxiliares para pruebas
‚îú‚îÄ‚îÄ auth.test.js          # Pruebas de autenticaci√≥n
‚îú‚îÄ‚îÄ appointment.test.js   # Pruebas de gesti√≥n de turnos
‚îú‚îÄ‚îÄ survey.test.js        # Pruebas de encuestas
‚îú‚îÄ‚îÄ analytics.test.js     # Pruebas de endpoints de anal√≠ticas
‚îú‚îÄ‚îÄ admin.test.js         # Pruebas del panel de administraci√≥n
‚îî‚îÄ‚îÄ message.test.js       # Pruebas del sistema de mensajer√≠a
```

## üß™ Categor√≠as de Pruebas

### 1. Pruebas de Autenticaci√≥n (`auth.test.js`)

- Registro de usuarios (pacientes, doctores)
- Inicio de sesi√≥n con credenciales v√°lidas/inv√°lidas
- Acceso a rutas protegidas
- Validaci√≥n de tokens JWT

### 2. Pruebas de Turnos (`appointment.test.js`)

- Crear turnos como paciente
- Ver turnos (vista de paciente y doctor)
- Actualizar estado del turno
- Cancelar turnos
- Listado de disponibilidad de doctores

### 3. Pruebas de Encuestas (`survey.test.js`)

- Enviar encuestas de satisfacci√≥n del paciente
- Ver las propias encuestas del paciente
- Acceso de admin a todas las encuestas
- Estad√≠sticas y an√°lisis de encuestas

### 4. Pruebas de Anal√≠ticas (`analytics.test.js`)

- Estad√≠sticas del sistema (cantidad de pacientes/doctores, etc.)
- Feed de actividad reciente
- Distribuci√≥n de turnos por especialidad
- Tendencias mensuales
- M√©tricas de rendimiento de doctores
- M√©tricas de participaci√≥n de pacientes

### 5. Pruebas de Admin (`admin.test.js`)

- Crear nuevos usuarios (todos los tipos)
- Gestionar usuarios existentes
- Crear perfiles de usuario
- Eliminaci√≥n de usuarios
- Controles de acceso exclusivos de admin

### 6. Pruebas de Mensajes (`message.test.js`)

- Crear conversaciones
- Enviar mensajes
- Historial de mensajes
- B√∫squeda de usuarios para mensajer√≠a
- Edici√≥n y eliminaci√≥n de mensajes

## üîß Configuraci√≥n

### Variables de Entorno

El entorno de prueba utiliza `.env.test`:

```env
PORT=4001
DATABASE_URL="postgres://cronos_user:cronos_pass@localhost:5433/cronos_test_db"
JWT_SECRET=CRONOS_HEALTH_JWT_SECRET_TEST
JWT_EXPIRATION=1h
NODE_ENV=test
```

### Configuraci√≥n de Jest

Configuraciones clave en `jest.config.js`:

- Timeout de 30 segundos para operaciones de base de datos
- Soporte para ES modules
- Informes de cobertura
- Aislamiento de pruebas
- Limpieza autom√°tica

## üêõ Depuraci√≥n de Pruebas

### Problemas Comunes

1. **Errores de Conexi√≥n a la Base de Datos**

   ```bash
   # Aseg√∫rate de que la base de datos de prueba est√© corriendo
   docker compose up -d postgres-test

   # Verifica si la base de datos es accesible
   docker exec -it cronos-test-db psql -U cronos_user -d cronos_test_db -c "SELECT 1;"
   ```

2. **Conflictos de Puerto**

   ```bash
   # Verifica si el puerto 5433 est√° en uso
   lsof -i :5433

   # Si est√° ocupado, det√©n otros servicios o cambia el puerto en docker-compose.yml
   ```

3. **Problemas con el Esquema**

   ```bash
   # Reiniciar el esquema de la base de datos de pruebas
   docker compose down postgres-test
   docker volume rm cronos-health-backend_pgdata-test
   docker compose up -d postgres-test
   ```

4. **Pruebas Colgadas**

   ```bash
   # Forzar salida si las pruebas se quedan colgadas
   npm test -- --forceExit

   # Verificar handles abiertos
   npm test -- --detectOpenHandles
   ```

### Salida Detallada

Para ver una salida detallada de las pruebas:

```bash
npm test -- --verbose
```

### Ejecutar Pruebas Espec√≠ficas

```bash
# Ejecutar solo pruebas de autenticaci√≥n
npm test -- auth.test.js

# Ejecutar pruebas que coincidan con un patr√≥n
npm test -- --testNamePattern="should create appointment"

# Ejecutar pruebas en un archivo espec√≠fico en modo observaci√≥n
npm test -- appointment.test.js --watch
```

## üìä Informes de Cobertura

Despu√©s de ejecutar `npm run test:coverage`:

- **Terminal**: Muestra resumen de cobertura
- **Informe HTML**: `coverage/lcov-report/index.html`
- **Datos LCOV**: `coverage/lcov.info`

Metas de cobertura:

- **Funciones**: > 80%
- **L√≠neas**: > 85%
- **Ramas**: > 75%

## üë• Equipo

- Desarrolladores: Amarfil Carolina, Ibarrola Tiago, Ozuna Maria, Pereyra Maximiliano y Skidelsky Dario.
